<div class="max-w-3xl mx-auto p-6">
  <h2 class="text-3xl font-semibold mb-6 text-gray-800">Update Booking</h2>

  <!-- Success Message -->
  @if (message) {
    <div class="mb-4 p-3 rounded-lg bg-green-100 text-green-700 border border-green-300">
      {{ message }}
    </div>
  }

  <!-- Error Message -->
  @if (error) {
    <div class="mb-4 p-3 rounded-lg bg-red-100 text-red-700 border border-red-300">
      {{ error }}
    </div>
  }

  <!-- Display booking details if fetched -->
  @if (!isLoading) {
    <!-- Booking Details -->
    <div class="bg-white p-6 shadow-md rounded-xl mb-6 space-y-3">
      <h3 class="text-xl font-semibold text-gray-800 mb-4">Booking Details</h3>
      <p class="text-gray-700"><strong class="font-medium">Confirmation Code:</strong> {{ bookingDetails.bookingReference }}</p>
      <p class="text-gray-700"><strong class="font-medium">Check-in Date:</strong> {{ bookingDetails.checkInDate }}</p>
      <p class="text-gray-700"><strong class="font-medium">Check-out Date:</strong> {{ bookingDetails.checkOutDate }}</p>
      
      <!-- Hiển thị giá tại thời điểm booking -->
      <p class="text-gray-700"><strong class="font-medium">Price per Night (at booking):</strong> {{ bookingDetails.pricePerNightAtBooking | currency }}</p>
      <p class="text-gray-700"><strong class="font-medium">Total Price:</strong> {{ bookingDetails.totalPrice | currency }}</p>
      
      <!-- Nếu giá phòng hiện tại khác giá lúc booking -->
      @if (bookingDetails.room?.pricePerNight !== bookingDetails.pricePerNightAtBooking) {
        <div class="p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
          <p class="text-sm text-yellow-800">
            <strong>Note:</strong> Current room price is {{ bookingDetails.room?.pricePerNight | currency }}/night
            (Price changed after booking was made)
          </p>
        </div>
      }
      
      <p class="text-gray-700">
        <strong class="font-medium">Payment Status:</strong> 
        <span [class]="'px-2 py-1 rounded text-sm ml-2 ' + getPaymentStatusClass(bookingDetails.paymentStatus)">
          {{ bookingDetails.paymentStatus }}
        </span>
      </p>
      <p class="text-gray-700">
        <strong class="font-medium">Booking Status:</strong> 
        <span [class]="'px-2 py-1 rounded text-sm ml-2 ' + getBookingStatusClass(bookingDetails.bookingStatus)">
          {{ bookingDetails.bookingStatus }}
        </span>
      </p>
    </div>

    <!-- Customer Details -->
    <div class="bg-white p-6 shadow-md rounded-xl mb-6 space-y-3">
      <h3 class="text-xl font-semibold text-gray-800 mb-4">Customer Details</h3>
      <p class="text-gray-700"><strong class="font-medium">First Name:</strong> {{ bookingDetails.user.firstName }}</p>
      <p class="text-gray-700"><strong class="font-medium">Last Name:</strong> {{ bookingDetails.user.lastName }}</p>
      <p class="text-gray-700"><strong class="font-medium">Email:</strong> {{ bookingDetails.user.email }}</p>
      <p class="text-gray-700"><strong class="font-medium">Phone Number:</strong> {{ bookingDetails.user.phoneNumber }}</p>
    </div>

    <!-- Room Details -->
    <div class="bg-white p-6 shadow-md rounded-xl mb-6 space-y-3">
      <h3 class="text-xl font-semibold text-gray-800 mb-4">Room Details</h3>
      <p class="text-gray-700"><strong class="font-medium">Type:</strong> {{ bookingDetails.room.type }}</p>
      <p class="text-gray-700"><strong class="font-medium">Room Number:</strong> {{ bookingDetails.room.roomNumber }}</p>
      <p class="text-gray-700"><strong class="font-medium">Current Price per Night:</strong> {{ bookingDetails.room.pricePerNight | currency }}</p>
      <p class="text-gray-700"><strong class="font-medium">Capacity:</strong> {{ bookingDetails.room.capacity }}</p>
      <p class="text-gray-700"><strong class="font-medium">Description:</strong> {{ bookingDetails.room.description }}</p>
      <img 
        [src]="'http://localhost:8080' + bookingDetails.room.imageUrl" 
        alt="Room Image" 
        class="w-full max-h-64 object-cover rounded-lg shadow mt-3"
      />
    </div>

    <!-- Guest Information -->
    @if (bookingDetails?.guests && bookingDetails.guests.length > 0) {
      <div class="bg-white p-6 shadow-md rounded-xl mb-6 space-y-3">
        <h3 class="text-xl font-semibold text-gray-800 mb-4">Guest Information ({{ bookingDetails.guests.length }})</h3>
        @for (guest of bookingDetails.guests; track guest.id; let i = $index) {
          <div class="border-b border-gray-200 pb-3 last:border-0 last:pb-0">
            <p class="text-gray-700"><strong class="font-medium">Guest {{ i + 1 }}:</strong></p>
            <p class="text-gray-600">{{ guest.firstName }} {{ guest.lastName }}</p>
            <p class="text-gray-600">{{ guest.email }}</p>
            <p class="text-gray-600">{{ guest.phoneNumber }}</p>
            @if (guest.identityNumber) {
              <p class="text-gray-600">ID: {{ guest.identityNumber }}</p>
            }
          </div>
        }
      </div>
    }

    <!-- Update Status Form -->
    <div class="bg-white p-6 shadow-md rounded-xl space-y-5">
      <h3 class="text-xl font-semibold text-gray-800 mb-4">Update Status</h3>

      <!-- Warning về business rules -->
      <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg text-sm text-blue-800">
        <p class="font-medium mb-2">⚠️ Status Update Rules:</p>
        <ul class="list-disc list-inside space-y-1 text-xs">
          <li>Cannot update cancelled bookings</li>
          <li>Cannot cancel after check-in</li>
          <li>Can only check-in on/after check-in date with PAID status</li>
          <li>Can only check-out after checked-in</li>
          <li>Payment status PAID can only change to REFUNDED</li>
        </ul>
      </div>

      <!-- Booking Status -->
      <div class="space-y-1">
        <label for="bookingStatus" class="font-medium text-gray-700">Booking Status</label>
        <select 
          id="bookingStatus" 
          name="bookingStatus" 
          [(ngModel)]="formState.bookingStatus" 
          (change)="handleChange($event)"
          class="w-full p-2 border border-gray-300 rounded-lg
                 focus:ring-2 focus:ring-blue-300 focus:outline-none"
        >
          <option value="">Select</option>
          <option value="BOOKED">BOOKED</option>
          <option value="CANCELLED">CANCELLED</option>
          <option value="CHECKED_IN">CHECKED IN</option>
          <option value="CHECKED_OUT">CHECKED OUT</option>
        </select>
      </div>

      <!-- Payment Status -->
      <div class="space-y-1">
        <label for="paymentStatus" class="font-medium text-gray-700">Payment Status</label>
        <select 
          id="paymentStatus" 
          name="paymentStatus" 
          [(ngModel)]="formState.paymentStatus" 
          (change)="handleChange($event)"
          class="w-full p-2 border border-gray-300 rounded-lg
                 focus:ring-2 focus:ring-blue-300 focus:outline-none"
        >
          <option value="">Select</option>
          <option value="PENDING">PENDING</option>
          <option value="PAID">PAID</option>
          <option value="CANCELLED">CANCELLED</option>
          <option value="FAILED">FAILED</option>
          <option value="REFUNDED">REFUNDED</option>
        </select>
      </div>

      <!-- Update Button -->
      <button 
        (click)="handleUpdate()"
        class="w-full bg-blue-600 text-white py-2.5 rounded-lg font-medium
               hover:bg-blue-700 transition shadow"
      >
        Update Booking
      </button>
    </div>
  }

  <!-- Loading State -->
  @if (isLoading) {
    <div class="bg-white p-6 shadow-md rounded-xl text-center">
      <p class="text-gray-700">Loading booking details...</p>
    </div>
  }
</div>